# .github/workflows/release-host.yml
# Creates a GitHub Release for the gpt_host binary.
# Builds all embedded VM artifacts + measurement tool via Docker for reproducibility,
# computes SEV-SNP launch measurement + SHA256 + optional IPFS CID,
# then tags and publishes a release with strong verification-focused notes.

name: "Release Unified Host Component"

on:
  push:
    paths:
      - "src/gpt_host/VERSION"
  workflow_dispatch:

concurrency:
  group: release-host-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

env:
  # Measurement parameters (keep in sync with gpt_measurement + host logic)
  VCPUS_FOR_MEASUREMENT: "4"

  # IPFS/Kubo version pin (binary distribution hashing)
  KUBO_VERSION: "v0.39.0"

  # Docker reproducibility knobs
  DOCKER_BUILDKIT: "1"
  COMPOSE_DOCKER_CLI_BUILD: "1"

  # Non-interactive apt
  DEBIAN_FRONTEND: noninteractive

jobs:
  release:
    runs-on: ubuntu-24.04
    timeout-minutes: 60

    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      digest: ${{ steps.measurement.outputs.digest }}
      host_sha256: ${{ steps.checksums.outputs.host_sha256 }}
      ipfs_cid: ${{ steps.ipfs.outputs.cid }}

    steps:
      # --- CHECKOUT & VERSION VALIDATION ---
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read and validate Host Version
        id: version
        shell: bash
        run: |
          set -euo pipefail

          VERSION_FILE="src/gpt_host/VERSION"
          if [[ ! -f "$VERSION_FILE" ]]; then
            echo "::error file=$VERSION_FILE::Version file not found"
            exit 1
          fi

          VERSION="$(tr -d '[:space:]' < "$VERSION_FILE")"
          if [[ -z "$VERSION" ]]; then
            echo "::error file=$VERSION_FILE::Version file is empty"
            exit 1
          fi

          # Tag namespace is intentionally scoped to host artifacts
          TAG="host/v${VERSION}"

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

          {
            echo "### Version Information"
            echo "- **Version:** \`$VERSION\`"
            echo "- **Tag:** \`$TAG\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Check if release tag already exists (remote)
        id: tag_check
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.version.outputs.tag }}"

          # Prefer remote check so a local shallow tag state doesn't mislead us.
          if git ls-remote --tags origin "refs/tags/${TAG}" | grep -q "${TAG}"; then
            echo "::warning::Tag ${TAG} already exists on origin. Skipping release."
            echo "tag_exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "tag_exists=false" >> "$GITHUB_OUTPUT"
          fi

      # --- BUILD ENVIRONMENT SETUP (NO RUST ON RUNNER; BUILDS HAPPEN IN DOCKER) ---
      - name: Install host dependencies
        if: steps.tag_check.outputs.tag_exists == 'false'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ca-certificates \
            curl \
            git \
            make \
            coreutils
          sudo update-ca-certificates

      - name: Set up Docker Buildx
        if: steps.tag_check.outputs.tag_exists == 'false'
        uses: docker/setup-buildx-action@v3

      # Optional but useful: allow buildx to reuse layers between runs.
      - name: Prepare build cache (warm-up)
        if: steps.tag_check.outputs.tag_exists == 'false'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: src/gpt_node/Dockerfile
          push: false
          load: false
          tags: gpt-cache:gpt_node
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Prepare workspace directories
        if: steps.tag_check.outputs.tag_exists == 'false'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts/vm artifacts/vm_cache
          mkdir -p target/x86_64-unknown-linux-musl/release
          mkdir -p target/x86_64-unknown-linux-gnu/release

      # --- BUILD ALL COMPONENTS (MATCH MAKEFILE ORDER) ---
      - name: Build Node binary (musl, docker)
        if: steps.tag_check.outputs.tag_exists == 'false'
        shell: bash
        run: |
          set -euo pipefail
          make build_node

      - name: Build VM OS (initrd + kernel; docker image + container run)
        if: steps.tag_check.outputs.tag_exists == 'false'
        shell: bash
        run: |
          set -euo pipefail
          make build_os

      - name: Build OVMF Firmware (docker image + container run)
        if: steps.tag_check.outputs.tag_exists == 'false'
        shell: bash
        run: |
          set -euo pipefail
          make build_ovmf

      - name: Build Host binary (embeds VM artifacts; docker)
        if: steps.tag_check.outputs.tag_exists == 'false'
        shell: bash
        run: |
          set -euo pipefail
          make build_host_binary

          HOST_BINARY="target/x86_64-unknown-linux-gnu/release/gpt_host"
          if [[ ! -f "$HOST_BINARY" ]]; then
            echo "::error::Host binary not found at $HOST_BINARY"
            exit 1
          fi

          chmod +x "$HOST_BINARY" || true

          {
            echo "### Host Binary Built"
            echo '```'
            ls -lh "$HOST_BINARY"
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Build measurement tool (docker)
        if: steps.tag_check.outputs.tag_exists == 'false'
        shell: bash
        run: |
          set -euo pipefail
          make build_measurement_tool

          MEAS_BIN="target/x86_64-unknown-linux-gnu/release/gpt_measurement"
          if [[ ! -f "$MEAS_BIN" ]]; then
            echo "::error::Measurement binary not found at $MEAS_BIN"
            exit 1
          fi
          chmod +x "$MEAS_BIN" || true

      # --- MEASUREMENT & CHECKSUMS ---
      - name: Calculate SEV-SNP launch measurement
        if: steps.tag_check.outputs.tag_exists == 'false'
        id: measurement
        shell: bash
        run: |
          set -euo pipefail

          MEAS_BIN="target/x86_64-unknown-linux-gnu/release/gpt_measurement"
          MEASUREMENT_DIGEST="$("$MEAS_BIN")"

          # expected format: 96 lowercase hex chars
          if ! [[ "$MEASUREMENT_DIGEST" =~ ^[a-f0-9]{96}$ ]]; then
            echo "::error::Invalid measurement digest format: $MEASUREMENT_DIGEST"
            exit 1
          fi

          echo "digest=$MEASUREMENT_DIGEST" >> "$GITHUB_OUTPUT"
          printf '%s\n' "$MEASUREMENT_DIGEST" > measurement.txt

          {
            echo "### SEV-SNP Launch Measurement"
            echo '```'
            echo "$MEASUREMENT_DIGEST"
            echo '```'
            echo "_Parameters: VCPUS=${{ env.VCPUS_FOR_MEASUREMENT }}, CPU=EpycMilan, Mode=SevSnp_"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Generate checksums
        if: steps.tag_check.outputs.tag_exists == 'false'
        id: checksums
        shell: bash
        run: |
          set -euo pipefail

          HOST_BINARY="target/x86_64-unknown-linux-gnu/release/gpt_host"

          HOST_SHA256="$(sha256sum "$HOST_BINARY" | awk '{print $1}')"
          echo "host_sha256=$HOST_SHA256" >> "$GITHUB_OUTPUT"

          # Component checksums (VM artifacts embedded into host)
          sha256sum artifacts/vm/* > embedded_sha256s.txt

          # Bundle a standard SHA256SUMS file for release consumers
          {
            echo "${HOST_SHA256}  gpt_host"
            sha256sum target/x86_64-unknown-linux-gnu/release/gpt_measurement | sed 's|  .*|  gpt_measurement|'
            # gpt_node is musl; include if present
            if [[ -f target/x86_64-unknown-linux-musl/release/gpt_node ]]; then
              sha256sum target/x86_64-unknown-linux-musl/release/gpt_node | sed 's|  .*|  gpt_node|'
            fi
            # VM artifact shas are already in embedded file; also include canonical names
            sha256sum artifacts/vm/OVMF.fd | sed 's|  .*|  OVMF.fd|'
            sha256sum artifacts/vm/vmlinuz | sed 's|  .*|  vmlinuz|'
            sha256sum artifacts/vm/initrd.gz | sed 's|  .*|  initrd.gz|'
          } > SHA256SUMS.txt

          {
            echo "### Artifact Checksums"
            echo "- **gpt_host (SHA256):** \`${HOST_SHA256}\`"
            echo ""
            echo "#### Embedded VM Components (SHA256)"
            echo '```'
            cat embedded_sha256s.txt
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      # --- IPFS CID (OPTIONAL DISTRIBUTION HASH) ---
      - name: Install and initialize IPFS (Kubo)
        if: steps.tag_check.outputs.tag_exists == 'false'
        shell: bash
        run: |
          set -euo pipefail
          KUBO_TARBALL="kubo_${{ env.KUBO_VERSION }}_linux-amd64.tar.gz"
          KUBO_URL="https://dist.ipfs.tech/kubo/${{ env.KUBO_VERSION }}/${KUBO_TARBALL}"

          curl -fsSL "$KUBO_URL" -o kubo.tar.gz
          tar -xzf kubo.tar.gz
          sudo ./kubo/install.sh

          # Use an isolated repo in the workspace (avoid touching runner HOME state)
          export IPFS_PATH="$GITHUB_WORKSPACE/.ipfs"
          ipfs init --profile server >/dev/null

      - name: Compute IPFS CID (only-hash)
        if: steps.tag_check.outputs.tag_exists == 'false'
        id: ipfs
        shell: bash
        run: |
          set -euo pipefail
          export IPFS_PATH="$GITHUB_WORKSPACE/.ipfs"

          HOST_BINARY="target/x86_64-unknown-linux-gnu/release/gpt_host"
          CID="$(ipfs add --only-hash -Q "$HOST_BINARY")"

          echo "cid=$CID" >> "$GITHUB_OUTPUT"
          printf '%s\n' "$CID" > ipfs_cid.txt

          {
            echo "### IPFS CID"
            echo '```'
            echo "$CID"
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      # --- CHANGELOG ---
      - name: Generate consolidated changelog
        if: steps.tag_check.outputs.tag_exists == 'false'
        id: changelog
        shell: bash
        run: |
          set -euo pipefail

          # Previous host tag (if any)
          LAST_TAG="$(git describe --tags --match="host/v*" --abbrev=0 2>/dev/null || true)"

          # Focus on code & build surfaces that affect gpt_host binary & measurement
          PATHS_TO_LOG="src/gpt_host src/gpt_node src/gpt_vm src/gpt_measurement makefiles Cargo.toml Cargo.lock"

          if [[ -z "${LAST_TAG}" ]]; then
            COMMIT_LOG="$(git log --pretty=format:"* %s (%h)" -- $PATHS_TO_LOG || true)"
          else
            COMMIT_LOG="$(git log "${LAST_TAG}..HEAD" --pretty=format:"* %s (%h)" -- $PATHS_TO_LOG || true)"
          fi

          if [[ -z "${COMMIT_LOG}" ]]; then
            COMMIT_LOG="* No relevant changes found in tracked directories."
          fi

          {
            echo "commit_log<<EOF"
            echo "${COMMIT_LOG}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          # Also write a file for release attachment
          printf '%s\n' "${COMMIT_LOG}" > CHANGELOG.txt

      # --- TAG & RELEASE ---
      - name: Create and push Git tag
        if: steps.tag_check.outputs.tag_exists == 'false'
        shell: bash
        run: |
          set -euo pipefail

          TAG="${{ steps.version.outputs.tag }}"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

      - name: Create GitHub Release (modern verification-focused notes)
        if: steps.tag_check.outputs.tag_exists == 'false'
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.version.outputs.tag }}
          name: "gpt_host v${{ steps.version.outputs.version }}"
          makeLatest: true
          artifactErrorsFailBuild: true
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: |
            target/x86_64-unknown-linux-gnu/release/gpt_host
            SHA256SUMS.txt
            embedded_sha256s.txt
            measurement.txt
            ipfs_cid.txt
            CHANGELOG.txt
          body: |
            ## gpt_host v${{ steps.version.outputs.version }}

            This release publishes the `gpt_host` binary used to manage and launch GPT Node VMs with **AMD SEV-SNP**.  
            The host binary is built with embedded VM artifacts (kernel, initrd, OVMF) and is accompanied by a pinned, reproducible measurement.

            ---

            ## Whatâ€™s included

            - **`gpt_host`** (Linux x86_64, GNU)
            - **`SHA256SUMS.txt`** (single-file verification for all attached artifacts)
            - **`embedded_sha256s.txt`** (checksums for embedded VM components)
            - **`measurement.txt`** (SEV-SNP launch measurement digest)
            - **`ipfs_cid.txt`** (content ID via `ipfs add --only-hash`)
            - **`CHANGELOG.txt`** (scoped changelog)

            ---

            ## Verification

            **1) Verify SHA256**
            ```bash
            sha256sum -c SHA256SUMS.txt
            ```

            **2) (Optional) Verify IPFS CID**
            ```bash
            # Should match ipfs_cid.txt
            ipfs add --only-hash -Q gpt_host
            ```

            ---

            ## SEV-SNP launch measurement

            **Parameters:** `VCPUS=${{ env.VCPUS_FOR_MEASUREMENT }}, CPU=EpycMilan, Mode=SevSnp`

            ```text
            ${{ steps.measurement.outputs.digest }}
            ```

            ---

            ## Embedded VM component checksums (SHA256)

            ```text
            (see embedded_sha256s.txt in release assets)
            ```

            ---

            ## Changelog (scoped)

            ${{ steps.changelog.outputs.commit_log }}

      - name: Release summary
        if: steps.tag_check.outputs.tag_exists == 'false'
        shell: bash
        run: |
          set -euo pipefail
          {
            echo "## ðŸŽ‰ Release Complete"
            echo "- **Tag:** \`${{ steps.version.outputs.tag }}\`"
            echo "- **Version:** \`${{ steps.version.outputs.version }}\`"
            echo "- **Host SHA256:** \`${{ steps.checksums.outputs.host_sha256 }}\`"
            echo "- **Measurement:** \`${{ steps.measurement.outputs.digest }}\`"
            echo "- **IPFS CID:** \`${{ steps.ipfs.outputs.cid }}\`"
            echo ""
            echo "[View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }})"
          } >> "$GITHUB_STEP_SUMMARY"
